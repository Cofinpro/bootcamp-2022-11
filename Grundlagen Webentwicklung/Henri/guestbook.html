<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Henris Cat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="images/caticon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style_guestbook.css">
    <script src="nojavascript.js"></script>
</head>

<body>
    <div class="inner_body">
        <button id="lightswitch" class="lightswitch" onclick="lightswitchOnClick()"></button>
        <header>
            <!-- Navigation -->
            <nav class="navigation_area">
                <ul>
                    <li>
                    <li>
                        <a href="./index.html">Main</a>
                    </li>
                    <li>
                        <a href="./animation.html">Animation</a>
                    </li>
                    <li>
                        <a href="./game.html">Game</a>
                    </li>
                    <li>
                        <a href="./slider.html">Slider</a>
                    </li>
                    <li>
                        <a href="./guestbook.html">Guestbook</a>
                    </li>
                </ul>
            </nav>
        </header>

        <div id="main">
            <div id="main_holder">
                <div id="left_part_holder">
                    <div class="name_holder">
                        Name:
                        <input id="name_input">
                    </div>
                    <div class="description_holder">
                        Message:
                        <input id="description_input">
                    </div>
                    <button id="submit_message_button" onclick="sendMessage()">Send Message</button>
                </div>

                <!-- Generated by code -->
                <div id="right_part_holder"></div>

            </div>

        </div>
</body>

<script>

    class Message {
        constructor(name, description, date) {
            this.name = name;
            this.description = description;
            this.date = date;
        }
    }


    const messages = []

    function init() {
        getData();
    }

    function getData() {
        let url = 'http://localhost:8080/api/v1/getall';

        fetch(url)
            .then(res => res.json())
            .then(out => out.forEach(message => addMessage(message)))
            .catch(err => fillWithLocalTestData());
    }

    function addMessage(json) {
        const message = new Message(json.name, json.description, new Date(json.date));
        messages.push(message);
        createMessageHtmlObject(message);
    }

    function fillWithLocalTestData() {
        console.log("Server not running - create local test data!");
        messages.push(new Message('Local TestUser 1', 'This is a message', new Date()));
        messages.push(new Message('Local TestUser 2', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 3', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 4', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 5', 'Lorem ipsum, dolor sit amet consectet cumque voluptate quasi, explicabo eaque exercitationem quae blanditiis optio veritatis provident recusandae eos ullam numquam est quisquam consectetur quam quaerat!', new Date()));
        messages.push(new Message('Local TestUser 6', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 7', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 8', 'This is also a message', new Date()));
        messages.push(new Message('Local TestUser 9', 'This is also a message', new Date()));

        messages.forEach(message => createMessageHtmlObject(message));
    }

    function createMessageHtmlObject(message) {
        const message_holder = document.createElement('div');
        message_holder.classList.add('message_holder');

        const message_header = document.createElement('div');
        message_header.classList.add('message_header');

        const message_user_name = document.createElement('div');
        message_user_name.classList.add('message_user_name');
        message_user_name.innerHTML = message.name;

        const message_date = document.createElement('div');
        message_date.classList.add('message_date');
        message_date.innerHTML = message.date.toISOString().split('T')[0];

        const message_description = document.createElement('div');
        message_description.classList.add('message_description');
        message_description.innerHTML = message.description;

        message_header.appendChild(message_user_name);
        message_header.appendChild(message_date);
        message_holder.appendChild(message_header);
        message_holder.appendChild(message_description);
        document.getElementById('right_part_holder').appendChild(message_holder);
    }


    function sendMessage() {
        let name = document.getElementById('name_input').value;
        let description = document.getElementById('description_input').value;

        //Checks
        if (!name) {
            alert("Please enter a name!");
            return;
        }
        if (!description) {
            alert("Please enter a description!");
            return;
        }
        if (description.toUpperCase().includes('DOG') || description.toUpperCase().includes('HUND')) {
            alert("Don't talk about dogs here!");
            return;
        }

        //Input is valid - create message
        const message = new Message(name, description, new Date());
        createMessageHtmlObject(message);

        //Make fields empty
        document.getElementById('name_input').value = '';
        document.getElementById('description_input').value = '';

        //Update database
        sendMessageToDatabase(message);
    }

    function sendMessageToDatabase(message) {
        let url = 'http://localhost:8080/api/v1/add';

        let json = JSON.stringify({
                "name": message.name,
                "description": message.description
            });

        fetch(url, {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: json
        });

    }

    //Init
    init();

</script>